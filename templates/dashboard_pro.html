<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xeinst Moderation Dashboard - Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .post-card { transition: all 0.2s ease-in-out; }
        .post-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-draft { @apply bg-yellow-50 border-yellow-200; }
        .status-approved { @apply bg-green-50 border-green-200; }
        .status-rejected { @apply bg-red-50 border-red-200; }
        .status-posted { @apply bg-blue-50 border-blue-200; }
        .similarity-high { @apply text-red-600 font-semibold; }
        .similarity-medium { @apply text-yellow-600 font-semibold; }
        .similarity-low { @apply text-green-600 font-semibold; }
        .loading { @apply animate-pulse; }
        .notification { @apply fixed top-4 right-4 z-50; }
    </style>
</head>
<body class="bg-gray-50" x-data="dashboard()" x-init="loadData()">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Xeinst Moderation Dashboard</h1>
                    <span class="ml-3 px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full">PRO</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <span x-text="new Date().toLocaleString()"></span>
                    </div>
                    <button @click="refreshData()" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-yellow-600 text-sm font-medium">üìù</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Drafts</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="stats.status_counts?.draft || 0"></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-green-600 text-sm font-medium">‚úÖ</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Approved</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="stats.status_counts?.approved || 0"></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-blue-600 text-sm font-medium">üì§</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Posted Today</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="stats.status_counts?.posted || 0"></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-red-600 text-sm font-medium">‚ùå</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Rejected</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="stats.status_counts?.rejected || 0"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Platform Statistics -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Platform Performance</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500">Reddit</span>
                        <span class="text-sm font-semibold text-gray-900" x-text="stats.platform_counts?.reddit || 0"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500">Bluesky</span>
                        <span class="text-sm font-semibold text-gray-900" x-text="stats.platform_counts?.bluesky || 0"></span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">System Status</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500">Kill Switch</span>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full" 
                              :class="stats.kill_switch ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                              x-text="stats.kill_switch ? 'ON' : 'OFF'"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-500">Hourly Limit</span>
                        <span class="text-sm font-semibold text-gray-900" x-text="stats.caps?.remaining_hourly || 0"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white rounded-lg shadow mb-6 p-4">
            <div class="flex flex-wrap items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Platform:</label>
                    <select x-model="filters.platform" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">All Platforms</option>
                        <option value="reddit">Reddit</option>
                        <option value="bluesky">Bluesky</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Status:</label>
                    <select x-model="filters.status" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="posted">Posted</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Search:</label>
                    <input type="text" x-model="filters.search" placeholder="Search posts..." 
                           class="border border-gray-300 rounded-md px-3 py-2 text-sm w-64">
                </div>
                
                <div class="flex items-center space-x-2">
                    <button @click="clearFilters()" class="px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                        Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bg-white rounded-lg shadow mb-6 p-4" x-show="selectedPosts.length > 0">
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700" x-text="`${selectedPosts.length} posts selected`"></span>
                <div class="flex space-x-2">
                    <button @click="bulkApprove()" class="px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">
                        Approve Selected
                    </button>
                    <button @click="bulkReject()" class="px-3 py-2 text-sm bg-red-600 text-white rounded-md hover:bg-red-700">
                        Reject Selected
                    </button>
                    <button @click="bulkDelete()" class="px-3 py-2 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-700">
                        Delete Selected
                    </button>
                </div>
            </div>
        </div>

        <!-- Posts List -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Posts Queue</h3>
            </div>
            
            <div class="divide-y divide-gray-200">
                <template x-for="post in filteredPosts" :key="post.id">
                    <div class="p-6 post-card" :class="`status-${post.status}`">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <input type="checkbox" :value="post.id" x-model="selectedPosts" 
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                          :class="{
                                              'bg-yellow-100 text-yellow-800': post.status === 'draft',
                                              'bg-green-100 text-green-800': post.status === 'approved',
                                              'bg-red-100 text-red-800': post.status === 'rejected',
                                              'bg-blue-100 text-blue-800': post.status === 'posted'
                                          }"
                                          x-text="post.status"></span>
                                    <span class="px-2 py-1 text-xs font-semibold bg-gray-100 text-gray-800 rounded-full"
                                          x-text="post.platform"></span>
                                </div>
                                
                                <h4 class="text-lg font-medium text-gray-900 mb-2" x-text="post.title"></h4>
                                <p class="text-gray-600 mb-3" x-text="post.body"></p>
                                
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span>Similarity: <span class="font-semibold" 
                                          :class="{
                                              'text-green-600': post.similarity_score < 0.3,
                                              'text-yellow-600': post.similarity_score >= 0.3 && post.similarity_score < 0.7,
                                              'text-red-600': post.similarity_score >= 0.7
                                          }"
                                          x-text="(post.similarity_score * 100).toFixed(1) + '%'"></span></span>
                                    <span>Created: <span x-text="new Date(post.created_at).toLocaleDateString()"></span></span>
                                </div>
                                
                                <div class="mt-3" x-show="post.policy_flags && post.policy_flags.length > 0">
                                    <div class="flex flex-wrap gap-1">
                                        <template x-for="flag in post.policy_flags" :key="flag">
                                            <span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-800 rounded-full"
                                                  x-text="flag"></span>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col space-y-2 ml-4">
                                <button @click="approvePost(post.id)" 
                                        class="px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">
                                    Approve
                                </button>
                                <button @click="rejectPost(post.id)" 
                                        class="px-3 py-1 text-sm bg-red-600 text-white rounded-md hover:bg-red-700">
                                    Reject
                                </button>
                                <button @click="editPost(post)" 
                                        class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Edit
                                </button>
                                <button @click="deletePost(post.id)" 
                                        class="px-3 py-1 text-sm bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <!-- Edit Modal -->
    <div x-show="editingPost" x-transition class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Edit Post</h3>
                <form @submit.prevent="saveEdit()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" x-model="editingPost.title" 
                               class="w-full border border-gray-300 rounded-md px-3 py-2">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                        <textarea x-model="editingPost.body" rows="4"
                                  class="w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" @click="editingPost = null" 
                                class="px-4 py-2 text-sm bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div x-show="notification.show" x-transition class="notification">
        <div class="px-4 py-3 rounded-md shadow-lg"
             :class="notification.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'">
            <span x-text="notification.message"></span>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                posts: [],
                stats: {},
                filters: {
                    platform: '',
                    status: '',
                    search: ''
                },
                selectedPosts: [],
                editingPost: null,
                notification: {
                    show: false,
                    message: '',
                    type: 'success'
                },
                
                async loadData() {
                    try {
                        // Load posts
                        const postsResponse = await fetch('/api/queue');
                        const postsData = await postsResponse.json();
                        this.posts = postsData.posts || [];
                        
                        // Load stats
                        const statsResponse = await fetch('/api/stats');
                        this.stats = await statsResponse.json();
                        
                        // Set up real-time updates
                        this.setupRealTimeUpdates();
                    } catch (error) {
                        console.error('Error loading data:', error);
                        this.showNotification('Error loading data', 'error');
                    }
                },
                
                setupRealTimeUpdates() {
                    const eventSource = new EventSource('/api/events');
                    eventSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.stats) {
                                this.stats = data.stats;
                            }
                            if (data.recent_posts) {
                                // Update posts with new data
                                this.posts = data.recent_posts;
                            }
                        } catch (error) {
                            console.error('Error parsing real-time data:', error);
                        }
                    };
                },
                
                async refreshData() {
                    await this.loadData();
                    this.showNotification('Data refreshed', 'success');
                },
                
                get filteredPosts() {
                    let filtered = this.posts;
                    
                    if (this.filters.platform) {
                        filtered = filtered.filter(p => p.platform === this.filters.platform);
                    }
                    
                    if (this.filters.status) {
                        filtered = filtered.filter(p => p.status === this.filters.status);
                    }
                    
                    if (this.filters.search) {
                        const search = this.filters.search.toLowerCase();
                        filtered = filtered.filter(p => 
                            p.title.toLowerCase().includes(search) || 
                            p.body.toLowerCase().includes(search)
                        );
                    }
                    
                    return filtered;
                },
                
                clearFilters() {
                    this.filters = {
                        platform: '',
                        status: '',
                        search: ''
                    };
                },
                
                async approvePost(postId) {
                    try {
                        const response = await fetch(`/api/posts/${postId}/approve`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            this.showNotification('Post approved successfully', 'success');
                            await this.loadData();
                        } else {
                            this.showNotification('Failed to approve post', 'error');
                        }
                    } catch (error) {
                        console.error('Error approving post:', error);
                        this.showNotification('Error approving post', 'error');
                    }
                },
                
                async rejectPost(postId) {
                    try {
                        const response = await fetch(`/api/posts/${postId}/reject`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            this.showNotification('Post rejected successfully', 'success');
                            await this.loadData();
                        } else {
                            this.showNotification('Failed to reject post', 'error');
                        }
                    } catch (error) {
                        console.error('Error rejecting post:', error);
                        this.showNotification('Error rejecting post', 'error');
                    }
                },
                
                editPost(post) {
                    this.editingPost = { ...post };
                },
                
                async saveEdit() {
                    try {
                        const response = await fetch(`/api/posts/${this.editingPost.id}/edit`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: this.editingPost.title,
                                body: this.editingPost.body
                            })
                        });
                        
                        if (response.ok) {
                            this.showNotification('Post updated successfully', 'success');
                            this.editingPost = null;
                            await this.loadData();
                        } else {
                            this.showNotification('Failed to update post', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating post:', error);
                        this.showNotification('Error updating post', 'error');
                    }
                },
                
                async deletePost(postId) {
                    if (!confirm('Are you sure you want to delete this post?')) return;
                    
                    try {
                        const response = await fetch(`/api/posts/${postId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            this.showNotification('Post deleted successfully', 'success');
                            await this.loadData();
                        } else {
                            this.showNotification('Failed to delete post', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting post:', error);
                        this.showNotification('Error deleting post', 'error');
                    }
                },
                
                async bulkApprove() {
                    if (this.selectedPosts.length === 0) return;
                    
                    try {
                        const response = await fetch('/api/bulk/approve', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                post_ids: this.selectedPosts,
                                notes: 'Bulk approved'
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            this.showNotification(`Approved ${result.approved_count} posts`, 'success');
                            this.selectedPosts = [];
                            await this.loadData();
                        } else {
                            this.showNotification('Failed to approve posts', 'error');
                        }
                    } catch (error) {
                        console.error('Error bulk approving:', error);
                        this.showNotification('Error bulk approving posts', 'error');
                    }
                },
                
                async bulkReject() {
                    if (this.selectedPosts.length === 0) return;
                    
                    try {
                        const response = await fetch('/api/bulk/reject', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                post_ids: this.selectedPosts,
                                reason: 'Bulk rejected'
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            this.showNotification(`Rejected ${result.rejected_count} posts`, 'success');
                            this.selectedPosts = [];
                            await this.loadData();
                        } else {
                            this.showNotification('Failed to reject posts', 'error');
                        }
                    } catch (error) {
                        console.error('Error bulk rejecting:', error);
                        this.showNotification('Error bulk rejecting posts', 'error');
                    }
                },
                
                async bulkDelete() {
                    if (this.selectedPosts.length === 0) return;
                    if (!confirm(`Are you sure you want to delete ${this.selectedPosts.length} posts?`)) return;
                    
                    try {
                        const response = await fetch('/api/bulk/delete', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                post_ids: this.selectedPosts
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            this.showNotification(`Deleted ${result.deleted_count} posts`, 'success');
                            this.selectedPosts = [];
                            await this.loadData();
                        } else {
                            this.showNotification('Failed to delete posts', 'error');
                        }
                    } catch (error) {
                        console.error('Error bulk deleting:', error);
                        this.showNotification('Error bulk deleting posts', 'error');
                    }
                },
                
                showNotification(message, type = 'success') {
                    this.notification = {
                        show: true,
                        message: message,
                        type: type
                    };
                    
                    setTimeout(() => {
                        this.notification.show = false;
                    }, 3000);
                }
            }
        }
    </script>
</body>
</html>
